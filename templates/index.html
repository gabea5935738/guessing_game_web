<!DOCTYPE html>
<html>
<head>
    <title>Guess the Number</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Sound effects -->
    <audio id="sound-correct" src="{{ url_for('static', filename='resources/correct-356013.mp3') }}" preload="auto"></audio>
    <audio id="sound-incorrect" src="{{ url_for('static', filename='resources/wronganswer-37702.mp3') }}" preload="auto"></audio>
    <div id="game-container">
        <h1>Guess the Number</h1>
        <div id="score">Score: {{ score }}</div>
        <div id="attempts">Attempt: {{ attempts }} / {{ max_attempts }}</div>
        <script>
        function updateIdleScore() {
            fetch("/idle_score").then(r => r.json()).then(data => {
                document.getElementById("score").textContent = "Score: " + data.score;
                let idleGen = data.idle_generator;
                let idleSpan = document.getElementById("idle-gen-info");
                if (idleSpan) {
                    idleSpan.textContent = `Idle Generators: ${idleGen} (${idleGen} pts/sec)`;
                }
            });
        }
        setInterval(updateIdleScore, 1000);

        // Play correct/incorrect sound based on message
        document.addEventListener('DOMContentLoaded', function() {
            const msg = document.getElementById('message');
            if (msg) {
                const text = msg.textContent || msg.innerText;
                if (text.includes('Correct!')) {
                    document.getElementById('sound-correct').currentTime = 0;
                    document.getElementById('sound-correct').play();
                } else if (text.toLowerCase().includes('too low') || text.toLowerCase().includes('too high') || text.toLowerCase().includes('game over')) {
                    document.getElementById('sound-incorrect').currentTime = 0;
                    document.getElementById('sound-incorrect').play();
                }
            }
        });
        </script>
        {% if message %}
            <div id="message">{{ message }}</div>
        {% endif %}
        <div id="guess-log">
            <strong>Guesses:</strong> {{ log|join(', ') if log else 'None yet' }}
        </div>
        <div id="item-actions" style="margin:0.7em 0 1em 0;">
            <form method="POST" style="display:inline;">
                <button type="submit" name="use_hint" {% if hint == 0 %}disabled{% endif %}>Hint ({{ hint }})</button>
            </form>
            <form method="POST" style="display:inline;">
                <button type="submit" name="use_extra_guess" {% if extra_guess == 0 %}disabled{% endif %}>Extra Guess ({{ extra_guess }})</button>
            </form>
            <br>
            <span style="margin-left:1em; font-weight:bold; color:#2563eb;">Score Multipliers: {{ score_multiplier }}</span>
            <br>
            <span id="idle-gen-info" style="margin-left:1em; font-weight:bold; color:#2563eb;">Idle Generators: {{ session.get('idle_generator', 0) }} ({{ session.get('idle_generator', 0) }} pts/sec)</span>
        </div>
        {% if achievements %}
        <div id="achievements" style="margin:1em 0; padding:0.7em; background:#e0ffe0; border-radius:8px; color:#222;">
            <strong>Achievements:</strong>
            <ul style="margin:0.5em 0 0 1.2em;">
                {% for ach in achievements %}
                <li>{{ ach }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if round_over %}
            <form method="POST">
                <button type="submit" name="next_round">Next Round</button>
            </form>
        {% else %}
            <form id="guess-form" method="POST" autocomplete="off">
                <input type="number" name="guess" min="{{ min_num }}" max="{{ max_num }}" required placeholder="Enter your guess">
                <button type="submit">Guess</button>
            </form>
        {% endif %}
        <div style="margin-top:1.5em; text-align:center;">
            <a href="{{ url_for("reset") }}">Restart Game</a> |
            <a href="{{ url_for("change_difficulty") }}">Change Difficulty</a> |
            <a href="{{ url_for("shop") }}">Shop</a>
        </div>
    </div>
    {% if session.get('debug') %}
    <div id="debug-panel">
        <strong>DEBUG MODE ON</strong><br>
        <form method="post" action="/set_var" style="margin:1em 0;">
            <input type="text" name="assignment" placeholder="var = value" required style="width:120px;">
            <button type="submit">Set Variable</button>
        </form>
        <form method="post" action="/force_next_round" style="margin:1em 0;">
            <button type="submit">Force Next Round</button>
        </form>
        <form method="post" action="/goto_page" style="margin:1em 0;">
            <input type="text" name="page" placeholder="Route (e.g. /, /game)" required>
            <button type="submit">Go To Page</button>
        </form>
                <pre>{{ session | pprint }}</pre>
                <div style="margin-top:1em; background:#222; color:#fff; padding:0.7em; border-radius:8px;">
                    <strong>All Routes:</strong>
                    <ul style="font-size:0.97em; margin:0; padding-left:1.2em;">
                        {% for route in all_routes %}
                            <li><code>{{ route.rule }}</code> ({{ route.methods }}) &rarr; <b>{{ route.endpoint }}</b></li>
                        {% endfor %}
                    </ul>
                </div>
      </div>
        <!-- Also update debug panel score if present
        function updateDebugScore() {
            fetch("/idle_score").then(r => r.json()).then(data => {
            
                let debugScore = document.getElementById("debug-live-score");
                if (debugScore) debugScore.textContent = "Score: " + data.score;
            });
        }
        setInterval(updateDebugScore, 1000);-->
    {% endif %}
</body>
</html>